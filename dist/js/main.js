"use strict";function clear(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function displayError(e){var a=document.createElement("p");a.setAttribute("class","errorMessage"),a.innerHTML=e,error.appendChild(a)}function initialize(){myLatlng=new google.maps.LatLng(45.5015217,-73.5732091),mapOptions={zoom:14,center:myLatlng,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(mapCanvas,mapOptions),infowindow=new google.maps.InfoWindow({}),viewModel.fetchPhotos(45.5015217,-73.5732091),viewModel.fetchWeatherInfo(45.5015217,-73.5732091)}var myLatlng,mapOptions,map,infowindow,marker,mapCanvas=document.getElementById("map-canvas"),places,latInsta,lngInsta,instagramURL,instagramNode=document.getElementById("instagram"),error=document.getElementById("error"),searchBox=new google.maps.places.SearchBox(document.getElementById("location-input"));google.maps.event.addListener(searchBox,"places_changed",function(){clear(error),$("#toggle-search").trigger("click"),places=searchBox.getPlaces(),places[0]?(latInsta=places[0].geometry.location.G,lngInsta=places[0].geometry.location.K,map=new google.maps.Map(mapCanvas,{zoom:14,center:new google.maps.LatLng(latInsta,lngInsta),mapTypeId:google.maps.MapTypeId.ROADMAP}),infowindow=new google.maps.InfoWindow,viewModel.fetchPhotos(latInsta,lngInsta),viewModel.fetchWeatherInfo(latInsta,lngInsta)):displayError("No such place, try again.")});var Model=function(e,a,t,o,n){this.photoId=ko.observable(e),this.imgURL=ko.observable(a),this.caption=ko.observable(t),this.lat=ko.observable(o),this.lon=ko.observable(n)},viewModel={city:ko.observable(""),humidity:ko.observable(""),temp:ko.observable(""),summary:ko.observable(""),iconURL:ko.observable(""),photos:ko.observableArray([]),fetchPhotos:function(e,a){instagramURL="https://api.instagram.com/v1/media/search?lat="+e+"&lng="+a+"&access_token=322608956.c39a870.654d8fb14b8d48838cc430bebcb0dede",$.ajax({type:"GET",url:instagramURL,dataType:"jsonp",success:viewModel.renderPhotos})},renderPhotos:function(e){if(e.data){viewModel.photos.removeAll();for(var a,t,o,n=0,i=e.data.length;i>n;n++)o="photo-"+n,t=viewModel.hasTitle(e.data[n]),a=new Model(o,e.data[n].images.thumbnail.url,t,e.data[n].location.latitude,e.data[n].location.longitude),viewModel.photos.push(a),marker=new google.maps.Marker({position:new google.maps.LatLng(e.data[n].location.latitude,e.data[n].location.longitude),map:map}),google.maps.event.addListener(marker,"click",function(a,t){var o="<div class='infoWindow'><img src='"+e.data[t].images.thumbnail.url+"'><p>"+viewModel.hasTitle(e.data[t])+"</p><b>@"+e.data[t].user.username+"</p></div>";return function(){infowindow.setContent(o),infowindow.open(map,a)}}(marker,n)),document.getElementById(o).addEventListener("click",function(e){return function(){google.maps.event.trigger(e,"click")}}(marker))}else displayError("No photos found...")},hasTitle:function(e){return e.caption&&e.caption.text?e.caption.text:"No Title"},fetchWeatherInfo:function(e,a){var t="http://api.openweathermap.org/data/2.5/weather?lat="+e+"&lon="+a+"&units=metric";$.ajax({type:"GET",url:t,success:viewModel.renderWeather,dataType:"jsonp"})},renderWeather:function(e){if(e.main){var a=e.name,t=e.main.humidity+"%",o=e.main.temp+"â„ƒ",n=e.weather[0].description,i="http://openweathermap.org/img/w/"+e.weather[0].icon+".png";viewModel.city(a),viewModel.humidity(t),viewModel.temp(o),viewModel.summary(n),viewModel.iconURL(i)}else displayError("No weather found for this city...")}};ko.applyBindings(viewModel),google.maps.event.addDomListener(window,"load",initialize),$("#toggle-search").click(function(){$("#location-input").toggle(300),$("#toggle-search").text("Search"===$("#toggle-search").text()?"Hide":"Search")}),$("#toggle-weather").click(function(){$("#weather-box").toggle(500),$("#toggle-weather").text("Weather"===$("#toggle-weather").text()?"Hide":"Weather")});